---
title: "Summary MRIQC output"
author: "Stef Meliss"
date: "10/07/2020"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
#### setups ####

#### setups ####
#empty work space, load libraries and functions
rm(list=ls())

# define necessary directories
qualDir <- getwd()

# load libraries
library(dplyr)
library(ggplot2)
library(ggrepel)
library(grid)

# function to determine outliers
is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}

### downlaod data from OSF ###
version_official <- "fmri"
osfr::osf_auth() # log into OSF
project <- osfr::osf_retrieve_node("fhqb7")
target_dir <- osfr::osf_ls_files(project, pattern = "data") # looks at all files and directories in the project and defines the match with "data"
sub_dir <- osfr::osf_mkdir(target_dir, path = paste0(version_official)) # add folder in OSF data dir

osfr::osf_ls_files(sub_dir, pattern = "group_bold.tsv") %>%
  osfr::osf_download(conflicts = "overwrite")

# load in dataset
scanparam <- read.delim("group_bold.tsv")

# add columns
scanparam$subject <- gsub("_task-magictrickwatching_", "", scanparam$bids_name)
scanparam$subject <- gsub("_task-rest_", "", scanparam$subject)
scanparam$subject <- gsub("run-._bold", "", scanparam$subject)
scanparam$subject <- gsub("acq-._", "", scanparam$subject)

scanparam$group <- ifelse(grepl("control", scanparam$bids_name), "control", "experimental")

scanparam$task <- ifelse(grepl("magictrickwatching", scanparam$bids_name), "magictrickwatching", "rest")

scanparam$run <- ifelse(grepl("run-1", scanparam$bids_name), 1, 
                   ifelse(grepl("run-2", scanparam$bids_name), 2, 3))

scanparam$BOLD <- ifelse(grepl("magictrickwatching_run-1", scanparam$bids_name), "magictrickwatching_run-1", 
                    ifelse(grepl("magictrickwatching_run-2", scanparam$bids_name), "magictrickwatching_run-2", 
                           ifelse(grepl("magictrickwatching_run-3", scanparam$bids_name), "magictrickwatching_run-3", 
                                  ifelse(grepl("rest_run-1", scanparam$bids_name), "rest_run-1", 
                                         ifelse(grepl("rest_run-2", scanparam$bids_name), "rest_run-2",
                                                ifelse(grepl("magictrickwatching_acq-1_run-2", scanparam$bids_name), "magictrickwatching_acq-1_run-2",
                                                       ifelse(grepl("magictrickwatching_acq-2_run-2", scanparam$bids_name), "magictrickwatching_acq-2_run-2",
                                                              NA)))))))

# create ID column
scanparam$ID <- gsub("sub-control0", "", scanparam$subject)
scanparam$ID <- gsub("sub-experimental0", "", scanparam$ID)

# eliminate acq in BOLD
scanparam$acq <- gsub("_acq-1", "", scanparam$BOLD)
scanparam$acq <- gsub("_acq-2", "", scanparam$acq)

# shorten acq
scanparam$acq <- gsub("magictrickwatching", "magictricks", scanparam$acq)

# determine DV to analyse
DV_plot <- c("aor", "aqi", "dummy_trs", "dvars_nstd", "dvars_std", "dvars_vstd", "efc", "fber", 
             "fd_mean", "fd_num", "fd_perc", "fwhm_avg", "fwhm_x", "fwhm_y", "fwhm_z", 
             "gcor", "gsr_x", "gsr_y", "size_t", 
             "snr", "tsnr",
             "summary_bg_k", "summary_bg_mad", "summary_bg_mean", "summary_bg_median", "summary_bg_n", "summary_bg_p05", "summary_bg_p95", "summary_bg_stdv", 
             "summary_fg_k", "summary_fg_mad", "summary_fg_mean", "summary_fg_median","summary_fg_n", "summary_fg_p05", "summary_fg_p95", "summary_fg_stdv")


definitions <- c("AFNI’s outlier ratio. Mean fraction of outliers per fMRI volume, from AFNI’s 3dToutcount. Higher values indicate lower quality.",
                 "AFNI’s quality index. Mean quality index, from AFNI’s 3dTqual. Values close to 0 indicate higher quality.",
                 "Dummy scans.	Number of volumes in the beginning of the fMRI timeseries identified as non-steady state.",
                 "Derivatives of variance. The average change in mean intensity between each pair of fMRI volumes in a series. Higher values indicate more dramatic changes (e.g., due to motion or spiking)." ,
                 "Derivatives of variance. The average change in mean intensity between each pair of fMRI volumes in a series. Higher values indicate more dramatic changes (e.g., due to motion or spiking). The dvars_std metric is normalized with the standard deviation of the temporal difference time series." ,
                 "Derivatives of variance. The average change in mean intensity between each pair of fMRI volumes in a series. Higher values indicate more dramatic changes (e.g., due to motion or spiking). The dvars_vstd is a voxel-wise standardization of DVARS, where the temporal difference time series is normalized across time by that voxel standard deviation across time, before computing the RMS of the temporal difference [Nichols2013].",
                 "Entropy-focus criterion. Shannon entropy criterion. Higher values indicate more ghosting and/or head motion blurring.",
                 "Foreground-background energy ratio. The variance of voxels inside the brain divided by the variance of voxels outside the brain. Higher values indicate higher quality.",
                 "Framewise displacement - mean. A measure of subject head motion, which compares the motion between the current and previous volumes.Higher values indicate lower quality.",
                 "Framewise displacement - number. Number of timepoints with framewise displacement >0.5mm. Higher values indicate lower quality.",
                 "Framewise displacement - percent. Percent of timepoints with framewise displacement >0.5mm. Higher values indicate lower quality.",
                 "Full-width half-maximum smoothness. Image blurriness (full-width half-maximum) - average. Higher values indicate a blurrier image.",
                 "Full-width half-maximum smoothness. Image blurriness (full-width half-maximum) - x axis Higher values indicate a blurrier image.",
                 "Full-width half-maximum smoothness. Image blurriness (full-width half-maximum) - y axis Higher values indicate a blurrier image.",
                 "Full-width half-maximum smoothness. Image blurriness (full-width half-maximum) - z axis Higher values indicate a blurrier image.",
                 "Global correlation. Average correlation of all pairs of voxel time series inside of the brain. Illustrates differences between data due to motion/physiological noise/imaging artifacts. Values closer to zero are better.",
                 "Ghost-to-signal ratio. Ghost-to-signal ratio along the x encoding axis. Higher values indicate lower quality.",
                 "Ghost-to-signal ratio. Ghost-to-signal ratio along the y encoding axis. Higher values indicate lower quality.",
                 "Number of volumes minus dummy TRs.",
                 "Signal-to-noise ratio. Signal-to-noise ratio within the tissue mask. Higher values indicate higher quality.",
                 "Temporal signal-to-noise ratio. Temporal signal-to-noise ratio taking into account mean signal over time. Higher values indicate higher quality.",
                 
                 "Summary statistics for average intensities in background: kurtosis",
                 "Summary statistics for average intensities in background: median absolute deviation (MAD)",
                 "Summary statistics for average intensities in background: mean",
                 "Summary statistics for average intensities in background: median",
                 "Summary statistics for average intensities in background: n (number of voxels)",
                 "Summary statistics for average intensities in background: 5% percentile",
                 "Summary statistics for average intensities in background: 95% percentile",
                 "Summary statistics for average intensities in background: standard deviation",
                 
                 "Summary statistics for average intensities in foreground: kurtosis",
                 "Summary statistics for average intensities in foreground: median absolute deviation (MAD)",
                 "Summary statistics for average intensities in foreground: mean",
                 "Summary statistics for average intensities in foreground: median",
                 "Summary statistics for average intensities in foreground: n (number of voxels)",
                 "Summary statistics for average intensities in foreground: 5% percentile",
                 "Summary statistics for average intensities in foreground: 95% percentile",
                 "Summary statistics for average intensities in foreground: standard deviation"
                 )

interpretation <- c("aor values are low and do not differ depending on task or group. Additionally, there seems to be some variation throughout the experiment.", 
                    
                    "aqi are low and comparable for both tasks and groups. There is some variability throughout the experiement.", 
                    "Very low prevelence of dummy scans, max = 3.", 
                    
                    "Raw derivatives of variance look comparible across groups and tasks, few outliers (e.g. sub-control037, sub-control045, sub-experimental016).", 
                    
                    "Standardised derivatives of variance look similar across groups and tasks. These values are also stable across the course of the experiment.", 
                    
                    "Voxel-wise Standardized derivatives of variance are biased by one outlier (sub-control049_task-magictrickwatching_run-2), but otherwise low.", 
                    
                    "No values above 0.55, groups and task look very similar, values constant throughout the duration of the experiment.", 
                    
                    "Values comparable for both groups and tasks, only outlier with higher values (i.e. extremely good scans).", 
                    
                    "Mean framewise displacement looks comparable across tasks and groups, though some subjects have high values (e.g. sub-control037, sub-control045, sub-experimental016). Interestingly, average relative movement seems to be fairly stable within each participant throughout the course of the experiment - in comparison to what I reported in previous mark downs.", 
                    
                    "Number of scans above 0.5mm threshold is fairly low and comparable between tasks and groups. There are outliers, especially sub-control037, sub-control045. Again, values are fairly constant over the course of the experiment.",
                    
                    "Percentage of scans above threshold of 0.5mm is low on average, but also biased by outliers.", 
                    
                    "Average smoothness is comparable across tasks and groups, and has a small range [2.5; 2.9] and is stable throught the experiment.", 
                    
                    "Smoothness on x axis is comparable across tasks and groups, and has a small range [2.4; 2.9] and is stable throught the experiment.", 
                    
                    "Smoothness on y axis is comparable across tasks and groups, and has a small range [2.7; 3.3] and is stable throught the experiment.", 
                    
                    "Smoothness on z axis is comparable across tasks and groups, and has a small range [2.1;2.8] and is stable throught the experiment.", 
                    
                    "Global correlation is small and does not differ betweem groups and tasks. Values also seem moderately stable, but also show variations throughout the course of the experiment.", 
                    
                    "Low GSR values in x axis for both groups and tasks, values stable.",
                    
                    "Low GSR values in y axis for both groups and tasks, values stable, but sub-control007 and sub-control031 are identified as outliers.", 
                    
                    "size_t looks as expected given that there is some variation in the length of task runs.",
                    
                    "snr looks comparable between groups and tasks and stable throughout the experiment. Sub-experimental014 has outlying low values.",
                    
                    "tsnr is similar between groups and tasks, no outliers in either direction, but values show variance throughout the experiment.",
                    
                    "Some outliers in BG kurtosis, but values are stable and comparible groups and tasks.", 
                    
                    "Some outliers in BG MAD, but values are stable and comparible groups and tasks.", 
                    
                    "Stable BG mean values.", 
                    
                    "Stable BG median values.", 
                    
                    "Stable number of BG voxels across tasks (as expected). Low values for sub-experimental014, but that's due to large head.",

                    "BG 5% percentaile similar across groups and tasks, but some outliers and variation across the tasks.",
                    
                    "BG 95% percentaile more stable across the experiment and similar across groups and tasks.",

                    "BG STD comparable across groups and tasks. So reason to assume any slice or voxel outages.", 
                    
                    
                    
                    
                    
                    "Some outliers in FG kurtosis, but values are stable and comparible groups and tasks.", 
                    
                    "No outliers in FG MAD, but values are stable and comparible groups and tasks.", 
                    
                    "Stable FG mean values.", 
                    
                    "Stable FG median values.", 
                    
                    "Stable number of FG voxels across tasks (as expected). High values for sub-experimental014, but that's due to large head.",

                    "FG 5% percentile similar across groups, tasks, and the course of the experiment.",
                    
                    "FG 95% percentile more stable across the experiment and similar across groups and tasks.",

                    "BG STD comparable across groups and tasks. So reason to assume any slice or voxel outages.")


# determine font sizes
text_size <- 8
axis_text_size <- 10
axis_title_size <- 12
title_size <- 14
strip_text_size <- 12

```

This markdown summarises the output from MRIQC (https://mriqc.readthedocs.io/en/latest/about.html), a tool developed by the Poldrack Lab at Stanford University. This software extracts IQMs (Image Quality Metrics). Of note, many of those IQMs are "no-reference" metrics. The software implements nipype workflows relying on FSL, ANTs and AFNI.  

The workflow was specified as the following:  
* threshold for frame wise displacement 0.5 (this is similar to what has been suggested by Powers et al., 2005).
* head motion correction was performed using AFNI's *3dvolreg*
* additonally, despiking and slice timing correction has been performed

I used the raw nifti files (as they came out of the scanner), but concatenated them so that the time series only includes volumes covering the task. This was necessary because we had to stop the scanner manually at the end of the task.  

All images share the following scan paramters: 

* Slice Resolution: 64x64
* Num slices: 37
* Voxel Size: 3.0x3.0x3.75
* TR = 2000ms
* Num Volumes: rest = 300 (each), magictricks = 1140 (in total)  

In total, there are the following **output parameters**:

* aor  
* aqi  
* dummy_trs  
* dvars_nstd  
* dvars_std  
* dvars_vstd  
* efc  
* fber  
* fd_mean  
* fd_num  
* fd_perc  
* fwhm_avg  
* fwhm_x
* fwhm_y  
* fwhm_z  
* gcor  
* gsr_x  
* gsr_y  
* size_t
* snr
* tsnr
* summary_bg_k
* summary_bg_mad
* summary_bg_mean
* summary_bg_median  
* summary_bg_n  
* summary_bg_p05  
* summary_bg_p95
* summary_bg_stdv
* summary_fg_k  
* summary_fg_mad  
* summary_fg_mean  
* summary_fg_median  
* summary_fg_n  
* summary_fg_p05  
* summary_fg_p95  
* summary_fg_stdv  
  
  
Below, each of these parameters will be defined. Definitions have been copied from https://sarenseeley.github.io/BIDS-fmriprep-MRIQC.html#mriqc  
Additionally, for each of these parameters, **four graphs** have been created to explore them in the sample:  

a) Histogram for all scans  
b) Histogram divided by group (control vs experimental) and task (magictricks vs rest)  
c) Boxplot for each acquisition (magictricks_run-1 vs. magictricks_run-2 vs. magictricks_run-3 vs. rest_run-1 vs. rest_run-2)  
In the boxplot, outliers are determined as: value < quantile(value, 0.25) - 1.5 * IQR(value) | value > quantile(value, 0.75) + 1.5 * IQR(value). If a value was an outlier, it was labeled using subject ID. The labels are printed in black if this subject belongs to the control group and in grey if the subject belongs to the experimental group.
d) Spaghettiplot highlighting the timecourse of each of these parameters for each subject  
In the spaghetti plot, a subject was labeled if any of the values over time were larger than mean(value) + 1SD(value). Please note that the line for subject 16 makes a little dip for magictricks_run-2. This is because the scanner had to be stopped during the second block, so there are two acqusitions (both covering approximately half of the block).




```{r plots, echo=FALSE, message=FALSE, warning=FALSE,  fig.align = "center", out.width = '100%', fig.width = 11, results="asis"}
i <- 0
# loop over dependent variables to create plots 
for (DV in DV_plot){
  
  i <- i + 1
  # print out DV to Markdown
  cat("  \n### Summary", DV)
  cat("  \n")
  cat("  \n Definition:", definitions[i])
  cat("  \n")
  cat("  \n Interpretation:", interpretation[i])
  cat("  \n")
  
  # create data frame and recode memory as factors
  output <- scanparam
  output$value <- output[[DV]]
  output <- output[, c("subject", "ID", "group", "task", "run", "BOLD", "acq", "value")]
  
  # mean = red line; median = green line
  # Create a text
  Mean <- grobTree(textGrob(paste0("Mean = ", round(mean(output$value),2), " (SD = ", round(sd(output$value),2),")"), x=0.6,  y=0.9, hjust=0,
                            gp=gpar(col="red", fontsize=13, fontface="italic")))
  Median <- grobTree(textGrob(paste("Median =", round(median(output$value),2)), x=0.6,  y=0.85, hjust=0,
                              gp=gpar(col="green", fontsize=13, fontface="italic")))
  # (a) histogram for all 250 scans
  all <- ggplot(output, aes(x=value, col = group, fill = group)) + 
    geom_histogram(position = "stack", alpha=0.2, col = "black") +
    geom_vline(aes(xintercept = mean(value)),col='red', size=1) + 
    geom_vline(aes(xintercept = median(value)),col='green', size=1) + 
    theme_classic() +  scale_colour_grey() + scale_fill_grey() +
    labs(x=paste(DV), y="Frequency", title = "Histogram all scans") +
    theme(axis.text=element_text(size=axis_text_size), axis.title=element_text(size=axis_title_size, face="bold"), title=element_text(size =title_size, face="bold"), strip.text = element_text(size = strip_text_size)) 
  
  
  all <- all + annotation_custom(Mean) + annotation_custom(Median)
  cat("  \n")
  print(all)
  cat("  \n")
  
  # (b) histogram splitted by task and group
  # mean = red line; median = green line
  task <- ggplot(output, aes(x=value)) +
    theme_classic() +  #scale_colour_grey() +
    geom_histogram(position="dodge", alpha=0.2, col = "black") +
    geom_vline(data = plyr::ddply(output, c("task", "group"), summarize, mean = mean(value, na.rm = T)), aes(xintercept=mean), col='red') +
    geom_vline(data = plyr::ddply(output, c("task", "group"), summarize, median = median(value, na.rm = T)), aes(xintercept=median), col='green') +
    labs(x=paste(DV), y="Frequency", title = "Histogram scans split by task and group") +
    theme(axis.text=element_text(size=axis_text_size), axis.title=element_text(size=axis_title_size, face="bold"), title=element_text(size =title_size, face="bold"), strip.text = element_text(size = strip_text_size)) +
    facet_grid(group ~ task)
  # add mean and median as values
  xpos <- 0.5*(min(output$value) + max(output$value))
  ypos1 <- max(ggplot_build(task)$data[[1]]$count) - sd(ggplot_build(task)$data[[1]]$count)
  ypos2 <- ypos1 - 0.5*sd(ggplot_build(task)$data[[1]]$count)
  ypos3 <- ypos2 - 0.5*sd(ggplot_build(task)$data[[1]]$count)
  task <- task +
    geom_text(data = plyr::ddply(output, c("task", "group"), summarize, mean = round(mean(value, na.rm = T), 2)),
              aes(label=paste("Mean =", mean), x = xpos, y = ypos1), vjust = 0, hjust = 0, col='red') +
    geom_text(data = plyr::ddply(output, c("task", "group"), summarize, sd = round(sd(value, na.rm = T), 2)),
              aes(label=paste0("(SD = ", sd, ")"), x = xpos, y = ypos2), vjust = 0, hjust = 0, col='red') +
    geom_text(data = plyr::ddply(output, c("task", "group"), summarize, median = round(median(value, na.rm = T), 2)),
              aes(label=paste("Median =", median), x = xpos, y = ypos3), vjust = 0, hjust = 0, col='green')
  cat("  \n")
  print(task)
  cat("  \n")
  
  # create label for outliers in boxplot
  # outlier = x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x)
  output_outliers <- output %>%
    group_by(acq) %>%
    mutate(outlier = ifelse(is_outlier(value), ID, NA))
  # (c) create boxplot for each acquisition
  boxplot <- ggplot(output_outliers, aes(y = value, x = acq, label = outlier)) +
    geom_boxplot()  + #geom_jitter(color = "red") +
    geom_label_repel(aes(label = outlier, color = group), nudge_x = 0.15, direction = "y", hjust = 0, segment.size = 0.2) +
    theme_classic() + scale_colour_grey() + theme(legend.position="none") +
    labs(y=paste(DV), x="BOLD acquisition", title = "Boxplot for each acquisition") +
    theme(axis.text=element_text(size=axis_text_size), axis.title=element_text(size=axis_title_size, face="bold"), title=element_text(size =title_size, face="bold"), strip.text = element_text(size = strip_text_size))
  cat("  \n")
  print(boxplot)
  cat("  \n")
  
  # creeate label for spaghetti plot
  # line gets labeled if  parameter > mean + 1SD
  output$above <- ifelse((mean(output$value, na.rm = T) + sd(output$value, na.rm = T)) < output$value, output$ID, NA) # add ID in column if value > mean + 1SD
  output$unique <- output$ID %in% unique(output$above) # determine unique subject names
  output$test <- ifelse(output$unique & output$acq == "rest_run-2", output$ID, NA) # add label to last acq only
  # (d) create spaghetti plot for each subject
  subj <- ggplot(output, aes(x=acq, y = value, group=subject, col = ID)) + geom_line() +
    facet_grid(group ~ .) +
    theme_classic() + theme(legend.position="none") +
    scale_x_discrete(limits=c("rest_run-1", "magictricks_run-1", "magictricks_run-2", "magictricks_run-3", "rest_run-2")) +
    labs(y=paste(DV), x="BOLD acquisition", title = "Parameters over time per subject") +
    theme(axis.text=element_text(size=axis_text_size), axis.title=element_text(size=axis_title_size, face="bold"), title=element_text(size =title_size, face="bold"), strip.text = element_text(size = strip_text_size)) +
    geom_label_repel(aes(label = test), nudge_x = 1, na.rm = TRUE, label.size = 0.05)
  cat("  \n")
  print(subj)
  cat("  \n")
  
  # calculate the mean value and SD of the parameter for each subject
  mean_per_subject <- plyr::ddply(output, "subject", summarize, mean = mean(value, na.rm = T))
  sd_per_subject <- plyr::ddply(output, "subject", summarize, sd = sd(value, na.rm = T))
  # merge both data frames
  per_subject <- merge(mean_per_subject, sd_per_subject)
  # calculate mean and SD of subjectwise mean and SD
  mean_subjectmean <- round(mean(per_subject$mean), 4)
  sd_subjectmean <- round(sd(per_subject$mean), 4)
  mean_subjectsd <- round(mean(per_subject$sd), 4)
  sd_subjectsd <- round(sd(per_subject$sd), 4)
  
  # print to markdown
  cat("  \n")
  cat("  \n Mean of subject-wise mean:", mean_subjectmean)
  cat("  \n SD of subject-wise mean:", sd_subjectmean)
  cat("  \n Mean of subject-wise SD:", mean_subjectsd)
  cat("  \n SD of subject-wise SD:", sd_subjectsd)
  cat("  \n")

  
}
```